{{- /*
  Partial: ocd/components/handler.html
  Purpose: Acts as an error "adapter" or router. Receives structured errors from the validator partial and conditionally calls OCD error reporting partials.

  Requires a dictionary expecting the following keys:
  - scName (string)   : Shortcode name
  - errors (map)      : Returning error map from the validator partial
  - rules (map)       : Validation rules map of the shortcode
  - meta (map)        : Shortcode's metadata map
  - page (object)     : The shortcode's page context (`.Page`)
  - position (object) : The shortcode's position (`.Position`)

  Maps generic shape:
  - rules:
  {
  "validKeys": ["KEY1", "KEY2"],
  "params": {
  "KEY1": { "default": "value", "validation": "in_list", "list": ["v1", "v2"] },
  "KEY2": { "default": INTEGER, "validation": "is_positive_integer" },
  ...
  }
  }

  - meta:
  {
  "docURL"  "..."
  "example" "..."
  "errorCodes" { "invalidKey"   "c1", "invalidValue" "c2" }
  }

  - errors:
  {
  "isValid": false,
  "errors": { "invalidKeys": {"UNKNOWN": "value"}, "invalidValues": {...} },
  ...
  }

  Repo:https://github.com/oxypteros/alpha
*/}}
{{- $scName := .scName -}}
{{- $errors := .errors -}}
{{- $rules := .rules -}}
{{- $meta := .meta -}}
{{- $page := .page -}}
{{- $position := .position -}}

{{- /* - OCD conditional vars */}}
{{- $ocdWarnEnabled := .Site.Params.ocdWarn_enabled | default true -}}
{{- $ocdEnabled := and hugo.IsDevelopment (.Site.Params.ocd_enabled | default true) -}}

{{- /* * Check for invalid keys and fail fast. If not then check for invalid values. */}}
{{- /* ** Invalid parameters map */}}
{{- with $errors.invalidKeys -}}
  {{- $errorData := dict
    "ocdErrorCode"  $meta.errorCodes.invalidKey
    "scName"        $scName
    "invalidParams" .
    "validParams"   $rules.validKeys
    "page"          $page
    "position"      $position
    "example"       $meta.example
    "docURL"        $meta.docURL
  -}}

  {{- /* *** Render invalid params errors only on Hugo terminal */}}
  {{- if $ocdWarnEnabled }}
    {{- partial "ocd/components/warn/sc-invalid-params.html" $errorData -}}
  {{- end }}
  {{- /* *** Render invalid params errors only on page and on console */}}
  {{- if $ocdEnabled }}
    {{- partial "ocd/components/page/sc-invalid-params.html" $errorData -}}
    {{- partial "ocd/components/console/sc-invalid-params.html" $errorData -}}
  {{- end }}

{{- else }}
  {{- with $errors.invalidValues }}
    {{- /* ** Invalid values map */}}
    {{- $invalidValuesMap := dict -}}
    {{- range $key, $details := . }}
      {{- $invalidValuesMap = merge $invalidValuesMap (dict $key $details.value) -}}
    {{- end }}

    {{- $errorData := dict
      "ocdErrorCode"   $meta.errorCodes.invalidValue
      "scName"         $scName
      "invalidValues"  $invalidValuesMap
      "rules"          $rules
      "page"           $page
      "position"       $position
      "example"        $meta.example
      "docURL"         $meta.docURL
    -}}
    {{- /* *** Render invalid values errors only on Hugo terminal */}}
    {{- if $ocdWarnEnabled }}
      {{- partial "ocd/components/warn/sc-invalid-values.html" $errorData -}}
    {{- end }}
    {{- /* *** Render invalid values errors only on page and on console */}}
    {{- if $ocdEnabled }}
      {{- partial "ocd/components/page/sc-invalid-values.html" $errorData -}}
      {{- partial "ocd/components/console/sc-invalid-values.html" $errorData -}}
    {{- end }}
  {{- end }}
{{- end -}}
