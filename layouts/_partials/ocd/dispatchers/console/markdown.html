{{- /*
  Partial: ocd/dispatchers/console/markdown.html
  Purpose: Renders the console warnings for markdown errors.

  Repo: https://github.com/oxypteros/alpha
*/}}

{{- /* Input data from core/markdown/handler.logic */}}
{{- $mdErrors := . -}}

{{- /* Input data from 'data/ocd/console/markdown.toml' */}}
{{- $mdErrorDefs := site.Data.ocd.console.markdown -}}

{{- range $mdErrors }}
  {{- /*
    Dictionary keys provided by:
    '_markup/render-image.html'
  */}}
  {{- $code := .code | default "ocd-md-000" -}}
  {{- $path := .path -}}
  {{- $permalink := .permalink -}}
  {{- $destination := .destination -}}
  {{- $dir := .dir -}}
  {{- $alt := .alt -}}

  {{- /* Get markdown error values from data for console */}}
  {{- $entry := (index $mdErrorDefs $code) | default dict -}}

  {{- /* Define severity for console (css) */}}
  {{- $severity := $entry.severity | default "warning" -}}
  {{- $severityClass := cond (eq $severity "error") "ocd-console-error" "ocd-console-warning" -}}

  {{- /* Format values for default use */}}
  {{- $titleKey := $entry.title | default "OcdUnknownTitle" -}}
  {{- $title := i18n $titleKey | safeHTML -}}

  {{- $key := $entry.key -}}

  {{- $file := $entry.file -}}

  {{- $reasonKey := $entry.reason | default "OcdUnknownReason" -}}
  {{- $reason := i18n $reasonKey | safeHTML -}}

  {{- $solutionKey := $entry.solution | default "OcdUnknownSolution" -}}
  {{- $solution := i18n $solutionKey | safeHTML -}}

  {{- $preExample := i18n ($entry.preExample | default "Example:") | safeHTML -}}
  {{- $example := i18n ($entry.example | default "OcdUnknownExample") | safeHTML -}}

  {{- $docURL := $entry.docURL | default "https://alpha.oxypteros.com/docs/" | safeHTML -}}
  {{- $preDoc := $entry.preDoc | default "" -}}

  {{- /*
    Markdown local image not found (in bundle or assets)
    Code: ocd-md-101
  */}}
  {{- if eq $code "ocd-md-101" -}}
    {{- $reason = printf (i18n $reasonKey) $destination | safeHTML -}}
    {{- $example = printf (i18n $entry.example) $path $alt $destination | safeHTML -}}

    {{- /*
      Markdown remote image not found
      Code: ocd-md-103
    */}}
  {{- else if eq $code "ocd-md-103" -}}
    {{- $reason = printf (i18n $reasonKey) $destination | safeHTML -}}
       {{- $solution =  printf (i18n $solutionKey) $destination | safeHTML -}}

    {{- /*
      Missing alt from markdown image
      Code: ocd-md-104
    */}}
  {{- else if eq $code "ocd-md-104" -}}
    {{- $reason = printf (i18n $reasonKey) $destination | safeHTML -}}
    {{- $example = printf (i18n $entry.example) $path $destination | safeHTML -}}
    
    {{- /*
      Fallback for missing or undefined code
      Code: ocd-cfg-000 or undefined
    */}}
  {{- else }}
    {{- $reason = printf (i18n $reasonKey)  | safeHTML -}}
  {{- end -}}

  {{- /* Render the console template and the Js trigger */}}
  <div data-error="{{ $code }}"></div>
  <template data-alpha="{{ $code }}-template">
    <div class="ocd-console-explanation {{ $severityClass }}">
      {{- with $title }}
        <h2>
          {{- . -}}
        </h2>
      {{- end }}
      {{- with $reason }}
        <p>
          {{- . | safeHTML -}}
        </p>
      {{- end }}
      <br />
      {{- with $solution }}
        <div class="ocd-console-solution">
          <h3 class="ocd-console-h3">
            {{ i18n "OcdSolution" . | default "Solution:" }}
          </h3>
          <p>{{ . | safeHTML }}</p>
        </div>
      {{- end }}
      {{- with $example }}
        <div class="ocd-console-example">
          <h3>{{ $preExample }}</h3>
          <p class="ocd-mono ocd-mono-con-solution">
            {{- $example | safeHTML }}
          </p>
        </div>
      {{- end }}
    </div>
    <div class="ocd-console-doc">
      {{- if $preDoc }}
        <div class="hr hr-left"></div>
        {{- with $docURL }}
          <a href="{{ . }}"
            ><span class="ocd-mono"></span> {{ $preDoc }}
            {{ i18n "OcdDoc" . }}</a
          >
        {{- end }}
      {{- end }}
      <div class="hr hr-right"></div>
    </div>
  </template>
{{- end -}}
