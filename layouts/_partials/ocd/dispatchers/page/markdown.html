{{- /*
  Partial: ocd/dispatchers/page/markdown.html
  Purpose: Renders the page warnings for markdown errors.

  Repo: https://github.com/oxypteros/alpha
*/}}

{{- /* Input data from core/markdown/handler.logic */}}
{{- $mdErrors := . -}}

{{- /* Input data from 'data/ocd/page/markdown.toml' */}}
{{- $mdErrorDefs := site.Data.ocd.page.markdown -}}

{{- range $mdErrors }}

  {{- /*
    Dictionary keys provided by:
    '_markup/render-image.html'
  */}}
  {{- $code := .code | default "ocd-md-000" -}}
  {{- $path := .path -}}
  {{- $permalink := .permalink -}}
  {{- $destination := .destination -}}
  {{- $dir := .dir -}}
  {{- $alt := .alt -}}
  {{- $isBundle := .isBundle -}}

  {{- /* Get markdown error values from data for page */}}
  {{- $entry := index $mdErrorDefs $code -}}

  {{- /* Define severity for page card (css) */}}
  {{- $severity := $entry.severity | default "warning" -}}
  {{- $severityClass := cond (eq $severity "error") "ocd-card-error" "ocd-card-warning" -}}
  {{- $ocdIcon := cond (eq $severity "error") "#ocd-error-icon" "#ocd-warning-icon" -}}

  {{- /* Format values for default use */}}
  {{- $titleKey := $entry.title | default "OcdMdUnknownTitle" -}}
  {{- $title := i18n $titleKey | safeHTML -}}

  {{- $reasonKey := $entry.reason | default "OcdMdUnknownReason" -}}
  {{- $reason := printf (i18n $reasonKey) $destination | safeHTML -}}

  {{- $solutionKey := $entry.solution | default "OcdMdUnknownSolution" -}}
  {{- $solution := i18n $solutionKey | safeHTML -}}

  {{- $preExample := i18n ($entry.preExample | default "") | safeHTML -}}
  {{- $example := i18n ($entry.example | default "OcdMdUnknownExample") | safeHTML -}}

  {{- $docURL := $entry.docURL | default "https://alpha.oxypteros.com/docs/" | safeHTML -}}

  {{- /*
    Markdown local image not found (in bundle or assets)
    Code: ocd-md-101
  */}}
  {{ if eq $code "ocd-md-101" }}
    {{- if $isBundle }}
      {{- $example = printf (i18n $entry.example) $alt $destination | safeHTML -}}
    {{- else }}
      {{- $solutionAssetsKey := $entry.solutionAssets -}}
      {{- $solution = printf (i18n $solutionAssetsKey) $destination | safeHTML -}}
      {{- $exampleAssetsKey := $entry.exampleAssets -}}
      {{- $example = printf (i18n $exampleAssetsKey) $destination | safeHTML -}}
    {{- end }}

    {{- /*
      Markdown remote image not found
      Code: ocd-md-103
    */}}
  {{- else if eq $code "ocd-md-103" }}
    {{- $providedLink := i18n "OcdCardProvidedLink" -}}

    {{- /*
      Missing alt from markdown image
      Code: ocd-md-104
    */}}
  {{- else if eq $code "ocd-md-104" }}
    {{- $example = printf (i18n $entry.example) $destination | safeHTML -}}

    {{- /*
      Fallback for missing or undefined code
      Code: ocd-md-000 or undefined
    */}}
  {{- else }}
    {{- $reason = printf (i18n $reasonKey)  $code | safeHTML -}}
  {{- end }}

  {{- /* Render the page card */}}
  <div class="ocd ocd-card {{ $severityClass }} ocd-shadow">
    <header class="ocd-card-header">
      <h2 class="ocd-title">{{- with $title }}{{ . }}{{- end }}</h2>
      <svg aria-hidden="true" focusable="false" width="24" height="24">
        <use href="{{- $ocdIcon -}}"></use>
      </svg>
    </header>

    <div class="ocd-card-content">
      <div class="ocd-card-content-reason">
        {{- with $reason }}{{ . }}{{- end }}
      </div>
      <hr />
      <div class="ocd-card-content-solution">
        {{- with $solution }}{{ . }}{{- end }}
      </div>
    </div>

    <footer class="ocd-card-footer">
      <div class="ocd-card-footer-meta">
        <p>
          {{ with $preExample }}
            <strong>{{ . }}</strong>
          {{- end }}
          {{ with $example }}{{ . | safeHTML }}{{- end }}
        </p>
        <a
          class="ocd-mono"
          href="{{ $docURL }}"
          target="_blank"
          rel="noopener noreferrer"
          >{{ $code }}</a
        >
      </div>
    </footer>
  </div>
{{- end -}}
