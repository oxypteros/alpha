{{- /*
  Shortcode: about.html
  Purpose: Renders an about element with username and avatar.

  Target: Global

  Example:
  {{< about AUTHOR="" AVATAR="">}}
  /... Markdown Content ... /
  {{< /about>}}

  Params:
  - AUTHOR (string, optional): H2 heading. Fall back to frontmatter author
  - AVATAR (string, optional): Avatar filename placed inside /assets/img/

  Error handler:
  - ocdWarn (global)
  - OCD (scoped)

  Docs: https://alpha.oxypteros.com/docs/shortcodes/about
  Repo: https://github.com/oxypteros/alpha
*/}}
{{- $ocdWarnEnabled := .Site.Params.ocdWarn_enabled | default true -}}
{{- $ocdEnabled := and hugo.IsDevelopment (.Site.Params.ocd_enabled | default true) -}}

{{- /* * About Shortcode Data */}}
{{- $scName := "about" -}}
{{- /* ** About shortcode rules */}}
{{- $rules := dict
  "validKeys" (slice "AUTHOR" "AVATAR")
  "params" (dict
  "AUTHOR"      (dict "validation" "any_string")
  "AVATAR"   (dict "validation" "any_string")
  )
-}}

{{- /* ** About shortcode metadata */}}
{{- $errorMeta := dict
  "docURL" "https://alpha.oxypteros.com/docs/shortcodes/about"
  "example" "&lbrace;&lbrace;&lt; about<br />&nbsp;&nbsp;AUTHOR=\"John Smith\"<br />&nbsp;&nbsp;AVATAR=\"my-picture.jpg\"<br />&gt;&rbrace;&rbrace;<br />&nbsp;&nbsp;Author of the series...<br />&nbsp;&nbsp;&nbsp;(Markdown text)<br />&nbsp;&nbsp;...here for you.<br />&lbrace;&lbrace;&lt; /about &gt;&rbrace;&rbrace;"
  "errorCodes" (dict
  "invalidKey"   "ocd-sc-200"
  "missingImg"   "ocd-sc-209"
  )
  "imgFolder" "/assets/img"
-}}

{{- /* *  Validate shortcode input */}}
{{- $validationResult := partial "ocd/core/shortcodes/validator.logic.html" (dict "rules" $rules "userInput" .Params) -}}

{{- /* ** Conditions to render shortcode or OCD */}}
{{- /* *** Input validation */}}
{{- $validInput := $validationResult.isValid }}

{{- /* - On failed input validation call the OCD handler */}}
{{- if not $validInput }}
  {{ if or ($ocdWarnEnabled) ($ocdEnabled) }}
    {{- partial "ocd/core/shortcodes/handler.logic.html" (dict
      "scName"   .Name
      "errors"   $validationResult.errors
      "rules"    $rules
      "meta"     $errorMeta
      "page"     .Page
      "position" .Position
      )
    -}}
  {{- end }}
{{- end }}

{{- /* * On successful validations render shortcode */}}
{{- if $validInput }}
  {{- $data := $validationResult.data -}}
  {{- $content := .Inner | markdownify }}
  {{- /* - Image validation */}}
  {{- $path := printf "/img/%s" $data.avatar }}
  {{- $image := "" }}
  {{- if $data.avatar }}
    {{- $image = resources.Get $path }}
  {{- end }}
  {{- $warnImg := false }}
  {{- if and $data.avatar ( eq $image nil) }}
    {{- $warnImg = true }}
  {{- end }}

  {{- if $warnImg }}
    {{- if or ($ocdWarnEnabled) ($ocdEnabled) }}
      {{- $errorData := dict
        "context"         .
        "name"            $scName
        "docURL"          $errorMeta.docURL
        "errorCode"       $errorMeta.errorCodes.missingImg
        "scExample"       $errorMeta.example
        "filename"        $data.avatar
        "imgFolder"       $errorMeta.imgFolder
      -}}
      {{- partial "ocd/dispatchers/legacy/missing-img.html" $errorData }}
    {{- end }}
  {{- end }}

  {{- /* ** Shortcode Rendering */}}
  {{- /* - Create unique id's for aria-labels in case of multiple shortcodes */}}
  {{- $base := .Page.File.BaseFileName | urlize }}
  {{- $ordinal := .Ordinal | default (now.UnixNano) }}
  {{- $uid := printf "%s-%v" $base $ordinal }}
  <aside
    class="sc-about mb-32 flex w-full max-w-7xl flex-wrap justify-center gap-10 px-4"
    aria-labelledby="about-heading-{{- $uid -}}"
  >
    <div class="flex w-fit flex-col items-center gap-5">
      {{- if and $data.avatar $image }}
        {{- $webp := $image.Resize "100x100 webp" }}
        {{- $webp2x := $image.Resize "200x200 webp" }}
        <img
          class="border-out dark:border-out-d h-25 w-25 rounded-full border shadow-lg"
          src="{{ $webp.RelPermalink }}"
          srcset="{{ $webp.RelPermalink }} 1x, {{ $webp2x.RelPermalink }} 2x"
          loading="lazy"
          decoding="async"
          width="{{ $webp.Width }}"
          height="{{ $webp.Height }}"
          alt="{{ i18n "AvatarOf" . | default "Avatar of" }} {{ $data.author }}"
        />
      {{- end }}
      {{- with $data.author }}
        <h2
          id="about-heading-{{- $uid -}}"
          class="text-on-sur-var dark:text-on-sur-var-d w-fit text-center text-2xl"
        >
          {{- . -}}
        </h2>
      {{- else }}
        <h2 id="about-heading-{{- $uid -}}" class="sr-only">
          {{- i18n "AboutHeading" . | default "About Me" -}}
        </h2>
      {{- end }}
    </div>
    <article class="w-full max-w-xl">{{ $content }}</article>
  </aside>
{{- end -}}
