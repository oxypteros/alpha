{{- /*
  Shortcode: recommended.html
  Purpose: Renders a list of posts with `recommended = true`. The recommended
  post is retrieved by the `hugo.Store` set by `init-global-data` partial

  Target: _index.md (homepage, sections)

  Example:
  {{< recommended TITLE="" LIMIT="" >}}

  Params:
  - TITLE (string, optional): H2 heading.
  - LIMIT (integer, optional): Number of items to show (Default: 4).

  Error handler:
  - ocdWarn (global)
  - OCD (scoped)

  Docs: https://alpha.oxypteros.com/docs/shortcodes/recommended
  Repo: https://github.com/oxypteros/alpha
*/}}
{{- $ocdWarnEnabled := .Site.Params.ocdWarn_enabled | default true -}}
{{- $ocdEnabled := and hugo.IsDevelopment (.Site.Params.ocd_enabled | default true) -}}

{{- /* * Recommended Shortcode Data */}}
{{- $scName := "recommended" -}}
{{- /* ** Recommended shortcode rules */}}
{{- $rules := dict
  "validKeys" (slice "TITLE" "LIMIT")
  "params" (dict
  "TITLE"    (dict "validation" "any_string")
  "LIMIT" (dict "validation" "is_positive_integer")

  )
-}}
{{- /* ** Recommended shortcode metadata */}}
{{- $errorMeta := dict
  "docURL" "https://alpha.oxypteros.com/docs/shortcodes/recommended"
  "example" "&lbrace;&lbrace;&lt; recommended TITLE=\"Suggestions\" LIMIT=\"6\" &gt;&rbrace;&rbrace;"
  "errorCodes" (dict
  "invalidKey"   "ocd-sc-140"
  "invalidValue" "ocd-sc-141"
  "recNotFound"  "ocd-sc-142"
  )
-}}

{{- /* *  Validate shortcode input */}}
{{- $validationResult := partial "ocd/cores/validator.logic.html" (dict "rules" $rules "userInput" .Params) -}}

{{- /* ** Conditions to render shortcode or OCD */}}
{{- /* *** Input validation */}}
{{- $validInput := $validationResult.isValid }}


{{- /* - Retrieve recommended pages from the global store */}}
{{- $lang := .Page.Language.Lang | default .Site.Language.Lang -}}
{{- $recommendedKey := printf "recommended_%s" $lang -}}
{{- $recommendedPages := hugo.Store.Get $recommendedKey -}}

{{- /* *** Recommended post validation */}}
{{- $validRecommended := $recommendedPages}}


{{- /* - On failed recommended post retrieval show OCD shortcode unique warning */}}
{{- if and (not $validRecommended) ($validInput) }}
  {{- if or ($ocdWarnEnabled) ($ocdEnabled) }}
    {{- $errorData := dict
      "context"     .
      "scName"      $scName
      "docURL"      $errorMeta.docURL
      "errorCode"   $errorMeta.errorCodes.recNotFound
      "frontmatter" "recommended=true"
      "title"       (i18n "OcdScRecTitle")
      "consLine1"   (i18n "OcdScRecEnableFm")
    -}}
    {{- partial "ocd/views/errors/global-data.html" $errorData }}
  {{- end }}
{{- end }}

{{- /* - On failed input validation call the OCD handler */}}
{{- if not $validInput }}
  {{ if or ($ocdWarnEnabled) ($ocdEnabled) }}
    {{- partial "ocd/core/handler.logic.html" (dict
      "scName"   .Name
      "errors"   $validationResult.errors
      "rules"    $rules
      "meta"     $errorMeta
      "page"     .Page
      "position" .Position
      )
    -}}
  {{- end }}
{{- end }}

{{- /* * On successful validations render shortcode */}}
{{- if and $validInput $validRecommended }}
  {{- $data := $validationResult.data -}}
  {{- $intLimit := $data.limit | default 4 -}}

  {{- /* Get a sample, but donâ€™t exceed the $intLimit */}}
  {{- $sampleSize := math.Min (len $recommendedPages) $intLimit }}

  {{- /* Respect the limit */}}
  {{- $actualPages := first $sampleSize ($recommendedPages) }}

  {{- if gt (len $actualPages) 0 }}
    {{- /* Create unique id's for aria-labels in case of multiple shortcodes */}}
    {{- $base := .Page.File.BaseFileName | urlize }}
    {{- $ordinal := .Ordinal | default (now.UnixNano) }}
    {{- $uid := printf "%s-%v" $base $ordinal }}
    <section
      class="mt-8 mb-32 flex w-full max-w-7xl flex-col items-center px-4"
      aria-labelledby="recommended-heading-{{- $uid -}}"
    >
      {{- /* - Optional title rendering. */}}
      {{- with $data.title }}
        <h2
          id="recommended-heading-{{- $uid -}}"
          class="font-200 text-on-sur-var dark:text-on-sur-var-d w-full text-center text-4xl leading-normal wrap-break-word hyphens-manual sm:text-5xl"
        >
          {{- . -}}
        </h2>
      {{- else }}
        <h2 id="recommended-heading-{{- $uid -}}" class="sr-only">
          {{- i18n "RecommendedArticles" | default "Recommended Articles" -}}
        </h2>
      {{- end }}
      <div
        class="mt-24 flex w-full flex-wrap items-center justify-center gap-25"
      >
        {{- range $actualPages }}
          {{- partial "components/card-post.html" . }}
        {{- end }}
      </div>
    </section>
  {{- end }}
{{- end -}}
