{{- /*
  Shortcode: cta.html
  Purpose: Renders a Call To Action element with a button styled link.

  Target: _index.md (homepage, sections)

  Example:
  {{< cta TITLE="" BTN-TEXT="" BTN-LINK="" BTN-LABEL="" >}}
    /... Markdown .../ 
  {{< /cta >}} 
  
  Params: 
  - TITLE (string, optional): H2 heading.
  - BTN-TEXT (string, optional): Link text for link (button styled) 
  - BTN-LINK (string, optional): `href` attribute for link 
  - BTN-LABEL (string, optional):`aria-label` attribute for link 
  
  Error handler: 
  - ocdWarn (global) 
  - OCD (scoped)
  
  Docs: https://alpha.oxypteros.com/docs/shortcodes/cta 
  Repo: https://github.com/oxypteros/alpha 
*/}}
{{- $ocdWarnEnabled := .Site.Params.ocdWarn_enabled | default true -}}
{{- $ocdEnabled := and hugo.IsDevelopment (.Site.Params.ocd_enabled | default true) -}}

{{- /* * CTA Shortcode Data */}}
{{- $scName := "cta" -}}
{{- /* ** CTA shortcode rules */}}
{{- $rules := dict
  "validKeys" (slice "TITLE" "BTN-TEXT" "BTN-LINK" "BTN-LABEL")
  "params" (dict
  "TITLE"      (dict "validation" "any_string")
  "BTN-TEXT"   (dict "validation" "any_string")
  "BTN-LINK"   (dict "validation" "any_string")
  "BTN-LABEL"  (dict "validation" "any_string")
  )
-}}

{{- /* ** CTA shortcode metadata */}}
{{- $errorMeta := dict
  "docURL" "https://alpha.oxypteros.com/docs/shortcodes/cta"
  "example" "&lbrace;&lbrace;&lt; cta<br />&nbsp;&nbsp;TITLE=\"Enjoying the posts?\"<br />&nbsp;&nbsp;BTN-TEXT=\"Subscribe\"<br />&nbsp;&nbsp;BTN-LINK=\"/subscribe\"<br />&nbsp;&nbsp;BTN-LABEL=\"Go to subscription page\"<br />&gt;&rbrace;&rbrace;<br />&nbsp;&nbsp;Get new posts delivered **straight** to your inbox.<br />&lbrace;&lbrace;&lt; /cta &gt;&rbrace;&rbrace;"
  "errorCodes" (dict
  "invalidKey"   "ocd-sc-170"
  "invalidPairs" "ocd-sc-172"
  )
-}}

{{- /* *  Validate shortcode input */}}
{{- $validationResult := partial "ocd/components/validator.html" (dict "rules" $rules "userInput" .Params) -}}

{{- /* ** Conditions to render shortcode or OCD */}}
{{- /* *** Input validation */}}
{{- $validInput :=  $validationResult.isValid -}}

{{- /* - On failed input validation call the OCD handler */}}
{{- if not $validInput }}
  {{ if or ($ocdWarnEnabled) ($ocdEnabled) }}
    {{- partial "ocd/components/handler.html" (dict
      "scName"   .Name
      "errors"   $validationResult.errors
      "rules"    $rules
      "meta"     $errorMeta
      "page"     .Page
      "position" .Position
      )
    -}}
  {{- end }}
{{- end }}

{{- if $validInput }}
  {{- $data := $validationResult.data -}}

  {{- /* - Reassign the validator returned data to the vars used by the shortcode. */}}
  {{- $title := $data.title -}}
  {{- $subtitle := $data.subtitle -}}
  {{- $btnLink := (index $data "btn-link") -}}
  {{- $btnTxt := (index $data "btn-text") -}}
  {{- $btnAria := (index $data "btn-label") -}}

  {{- /* *** A pair is considered valid if: Both its parts (link and text)
    are defined. OR NEITHER of its parts are defined. The only "invalid" state is
    when one part is defined but the other is not.
  */}}
  {{- $isBtnPairValid := or (and $btnLink $btnTxt) (and (not $btnLink) (not $btnTxt)) -}}

  {{- if not $isBtnPairValid }}
    {{- /* - At least one pair is incomplete show OCD link pairs unique warning */}}
    {{- if or ($ocdWarnEnabled) ($ocdEnabled) }}
      {{- $errorData := dict
        "context"         .
        "scName"          $scName
        "docURL"          $errorMeta.docURL
        "errorCode"       $errorMeta.errorCodes.invalidPairs
        "scExample"       $errorMeta.example
        "isBtnPairValid"  $isBtnPairValid
        "btnLink"         $btnLink
        "btnTxt"          $btnTxt
      -}}
      {{- partial "ocd/components/unique/link-pairs-sc.html" $errorData }}
    {{- end }}
  {{- else }}
    {{- /* Shortcode Rendering */}}
    {{- $content := .Inner | markdownify }}
    {{- /* Create unique id's for aria-labels in case of multiple shortcodes */}}
    {{- $base := .Page.File.BaseFileName | urlize }}
    {{- $ordinal := .Ordinal | default (now.UnixNano) }}
    {{- $uid := printf "%s-%v" $base $ordinal }}
    <section
      class="mb-32 flex w-full max-w-7xl flex-col items-center px-4 text-center"
      aria-labelledby="cta-heading-{{- $uid -}}"
    >
      <div class="bg-out-var dark:bg-out-var-d h-0.5 w-full rounded-2xl"></div>

      <div
        class="my-16 flex w-full flex-col items-center justify-center gap-16"
      >
        {{- with $title }}
          <h2
            id="cta-heading-{{- $uid -}}"
            class="font-200 text-on-sur-var dark:text-on-sur-var-d w-full text-4xl leading-normal wrap-break-word hyphens-manual"
          >
            {{- . -}}
          </h2>
        {{- else }}
          <h2 id="cta-heading-{{- $uid -}}" class="sr-only">
            {{- i18n "CtaHeading" | default "What's Next?" -}}
          </h2>
        {{- end }}
        <div
          class="sc-cta-text font-300 max-w-[82ch] text-xl leading-relaxed [&>p]:mb-3"
        >
          {{ $content }}
        </div>
        {{- if and $btnLink $btnTxt }}
          <a
            class="btn-link bg-sur-var hover:bg-sur dark:bg-sur-var-d font-500 border-out-var dark:border-out-var-d hover:dark:bg-menu-d dark:text-on-sur-var-d text-on-sur-var dark:hover:text-on-sur-d hover:text-on-sur rounded-full border px-5 py-3 text-center font-sans shadow-lg transition-all duration-400 ease-in-out hover:shadow-md"
            href="{{- $btnLink -}}"
            {{- with $btnAria }}
              aria-label="{{ . }}"
            {{- end }}
            data-prefetch="true"
            >{{- $btnTxt -}}</a
          >
        {{- end }}
      </div>
      <div class="bg-out-var dark:bg-out-var-d h-0.5 w-full rounded-2xl"></div>
    </section>
  {{- end }}
{{- end -}}
