{{- /*
  Shortcode: num-list.html
  Purpose: Renders a numbered list of weighted child pages

  Target: _index.md (sections)

  Example:
  { {< num-list STYLE="" TITLE="" LIMIT="" >} }

  Params:
  - TITLE (string, optional): H2 heading.
  - STYLE (string, optional): Visual style of the list
  Values: pill, list, card-list, card (default)
  - LIMIT (int, optional): Maximum number of items.

  Error handler:
  - ocdWarn (global)
  - OCD (scoped)

  Docs: https://alpha.oxypteros.com/shortcodes/num-list
  Repo: https://github.com/oxypteros/alpha
*/}}

{{- $ocdWarnEnabled := .Site.Params.ocdWarn_enabled | default true -}}
{{- $ocdEnabled := and hugo.IsDevelopment (.Site.Params.ocd_enabled | default true) -}}

{{- /* * Num-list Shortcode Data */}}
{{- $scName := "num-list" -}}
{{- /* ** Num-list shortcode rules */}}
{{- $rules := dict
  "validKeys" (slice "TITLE" "STYLE" "LIMIT")
  "params" (dict
  "STYLE"  (dict "validation" "in_list" "list" (slice "card" "pill" "list" "card-list") "default" "card-list")
  "TITLE" (dict "validation" "any_string")
  "LIMIT" (dict "validation" "is_positive_integer")
  )
-}}
{{- /* ** Num-list shortcode metadata */}}
{{- $errorMeta := dict
  "docURL" "https://alpha.oxypteros.com/docs/shortcodes/num-list"
  "example" "&lbrace;&lbrace;&lt; num-list TITLE=\"Chapters\" STYLE=\"card\" LIMIT=\"6\" &gt;&rbrace;&rbrace;"
  "errorCodes" (dict
  "invalidKey"   "ocd-sc-180"
  "invalidValue" "ocd-sc-181"
  )
-}}
{{- /* *  Validate shortcode input */}}
{{- $validationResult := partial "ocd/core/validator.logic.html" (dict "rules" $rules "userInput" .Params) -}}

{{- /* ** Conditions to render shortcode or OCD */}}
{{- /* *** Input validation */}}
{{- $validInput := $validationResult.isValid }}

{{- /* - On failed input validation call the OCD handler */}}
{{- if not $validInput }}
  {{ if or ($ocdWarnEnabled) ($ocdEnabled) }}
    {{- partial "ocd/core/handler.logic.html" (dict
      "scName"   .Name
      "errors"   $validationResult.errors
      "rules"    $rules
      "meta"     $errorMeta
      "page"     .Page
      "position" .Position
      )
    -}}
  {{- end }}
{{- end }}

{{- /* * On successful validations render shortcode */}}
{{- if $validInput }}
  {{- $data := $validationResult.data -}}
  {{- $pages := .Page.Pages.ByWeight }}
  {{- /* - Apply limit if specified */}}
  {{- if $data.limit }}
    {{- $pages = first (int $data.limit) $pages }}
  {{- end }}
  {{- /* - Create unique id's for aria-labels in case of multiple shortcodes */}}
  {{- $base := .Page.File.BaseFileName | urlize }}
  {{- $ordinal := .Ordinal | default (now.UnixNano) }}
  {{- $uid := printf "%s-%v" $base $ordinal }}
  <section
    class="mt-8 mb-32 flex w-full max-w-7xl flex-col items-center px-4"
    aria-labelledby="list-heading-{{- $uid -}}"
  >
    {{- /* - Optional title rendering. */}}
    {{- with $data.title }}
      <div
        class="flex w-full min-w-0 items-center justify-center gap-4 sm:justify-normal"
      >
        <div
          class="bg-out-var dark:bg-out-var-d h-0.5 max-w-1/8 grow rounded-full"
        ></div>
        <h2
          id="list-heading-{{- $uid -}}"
          class="text-on-sur-var dark:text-on-sur-var-d font-300 min-w-0 text-3xl break-words hyphens-manual"
        >
          {{- . -}}
        </h2>
        <div class="bg-out-var dark:bg-out-var-d h-0.5 grow rounded-full"></div>
      </div>
    {{- else }}
      <h2 id="list-heading-{{- $uid -}}" class="sr-only">
        {{- i18n "NumListHeading" | default "Ordered Article List" -}}
      </h2>
    {{- end }}

    {{- /* - Style-based rendering. */}}
    {{- if eq $data.style "card" }}
      <nav
        class="sc-num-list my-16 flex w-full flex-wrap justify-center gap-10"
      >
        {{- range  $index, $page := $pages }}
          {{- /* - Style different first page */}}
          {{ $first := eq $index 0 }}
          <a
            class="{{- cond $first "first" "rest" }} group relative flex h-36 w-72 flex-col items-center justify-center overflow-hidden rounded-md border p-4 transition-all duration-400 hover:shadow-md lg:w-80"
            href="{{ .RelPermalink }}"
          >
            <div
              class="font-800 text-pri dark:text-pri-d absolute inset-x-0 inset-y-0 flex items-center justify-center text-9xl opacity-0 transition-opacity duration-300 group-hover:opacity-20"
              aria-hidden="true"
            >
              {{ add $index 1 }}
            </div>
            <h2 class="font-500 line-clamp-3 w-full text-center text-xl">
              {{ .Title }}
            </h2>
          </a>
        {{- end }}
      </nav>
    {{- else if eq $data.style "pill" }}
      <nav class="my-16 flex w-full flex-wrap justify-center gap-10">
        {{- range $index, $page := $pages }}
          <a
            class="border-out-var dark:border-out-var-d bg-sur dark:bg-sur-var-d text-on-sur-var dark:text-on-sur-var-d hover:bg-sur-var dark:hover:bg-out-d hover:text-on-sur dark:hover:text-on-sur-d group relative flex h-24 w-72 flex-col items-center justify-center rounded-md border p-4 transition-all duration-300 hover:shadow-md lg:w-80"
            href="{{ .RelPermalink }}"
          >
            <div class="font-800 absolute -top-3 -left-3" aria-hidden="true">
              <div
                class="border-out-var dark:border-out-var-d bg-sur-var dark:bg-out-var-d text-on-sur dark:text-on-sur-d group-hover:text-pri dark:group-hover:text-pri-d flex size-6 items-center justify-center rounded-full border text-sm transition-colors duration-300"
              >
                {{ add $index 1 }}
              </div>
            </div>
            <h2
              class="font-300 line-clamp-2 w-full text-center text-2xl transition-colors duration-300"
            >
              {{ .Title }}
            </h2>
          </a>
        {{- end }}
      </nav>
    {{- else if eq $data.style "list" }}
      <nav class="my-16 flex w-full flex-wrap justify-center gap-8">
        {{- range $index, $page := $pages }}
          <div class="flex gap-2">
            <span class="font-300 text-pri dark:text-pri-d text-xl"
              >{{ printf "%02d" (add $index 1) }}.</span
            >
            <a href="{{ .RelPermalink }}">
              <h2
                class="font-600 text-on-sur-var dark:text-on-sur-var-d hover:text-pri dark:hover:text-pri-d text-xl transition-colors duration-300"
              >
                {{ $page.Title }}
              </h2>
            </a>
          </div>
        {{- end }}
      </nav>
    {{- else if eq $data.style "card-list" }}
      <nav class="my-16 flex w-full flex-wrap justify-center gap-10">
        {{- range $index, $page := $pages }}
          <a
            class="border-out-var dark:border-out-var-d hover:bg-sur-var dark:hover:bg-out-d dark:bg-sur-var-d text-on-sur-var dark:text-on-sur-var-d group flex h-42 w-72 flex-col gap-4 rounded-md border p-4 transition-all duration-300 hover:shadow-md lg:w-96"
            href="{{ .RelPermalink }}"
          >
            <div
              class="font-700 group-hover:text-pri dark:group-hover:text-pri-d text-lg transition-colors duration-300"
            >
              {{ printf "%02d" (add $index 1) }}.
            </div>
            <h2
              class="line-clamp-3 text-center text-xl transition-colors duration-400"
            >
              {{ .Title }}
            </h2>
          </a>
        {{- end }}
      </nav>
    {{- end }}
  </section>
{{- end -}}
